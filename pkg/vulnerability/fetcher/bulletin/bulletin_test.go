package bulletin

import (
	"io"
	"os"
	"testing"

	"github.com/google/go-cmp/cmp"
	"github.com/google/go-cmp/cmp/cmpopts"
	"github.com/tealeg/xlsx"

	"github.com/vulsio/windows-vuln-feed/pkg/vulnerability/model"
)

func TestParse(t *testing.T) {
	var tests = []struct {
		input    string
		expected []model.Vulnerability
	}{
		{
			input: "./testdata/BulletinSearch.xlsx",
			expected: []model.Vulnerability{
				{
					CVEID: "CVE-2017-0009",
					Title: "Cumulative Security Update for Microsoft Edge",
					Products: []model.Product{
						{
							Name:     "Microsoft Edge on Windows 10 for 32-bit Systems",
							Impact:   "Remote Code Execution",
							Severity: "Critical",
							KBs: []model.KB{
								{
									Article:         "4012606",
									RestartRequired: "Yes",
									ArticleURL:      "https://support.microsoft.com/help/4012606",
									DownloadURL:     "https://catalog.update.microsoft.com/v7/site/Search.aspx?q=KB4012606",
								},
							},
						},
					},
					URL: "https://msrc.microsoft.com/update-guide/vulnerability/CVE-2017-0009",
					Revisions: []model.Revision{
						{
							Number:      "1.0",
							Date:        "2017-03-14T00:00:00Z",
							Description: "\u003cp\u003eInformation published.\u003c/p\u003e\n",
						},
					},
				},
				{
					CVEID: "CVE-2017-0024",
					Title: "Security Update for Windows Kernel-Mode Drivers",
					Products: []model.Product{
						{
							Name:     "Windows 10 Version 1511 for 32-bit Systems",
							Impact:   "Elevation of Privilege",
							Severity: "Important",
							KBs: []model.KB{
								{
									Article:         "4013198",
									RestartRequired: "Yes",
									ArticleURL:      "https://support.microsoft.com/help/4013198",
									DownloadURL:     "https://catalog.update.microsoft.com/v7/site/Search.aspx?q=KB4013198",
								},
							},
						},
						{
							Name:     "Windows Server 2008 for 32-bit Systems Service Pack 2",
							Impact:   "Elevation of Privilege",
							Severity: "Important",
							KBs: []model.KB{
								{
									Article:         "4012497",
									RestartRequired: "Yes",
									ArticleURL:      "https://support.microsoft.com/help/4012497",
									DownloadURL:     "https://catalog.update.microsoft.com/v7/site/Search.aspx?q=KB4012497",
								},
							},
						},
						{
							Name:     "Windows Server 2008 for x64-based Systems Service Pack 2",
							Impact:   "Elevation of Privilege",
							Severity: "Important",
							KBs: []model.KB{
								{
									Article:         "4012497",
									RestartRequired: "Yes",
									ArticleURL:      "https://support.microsoft.com/help/4012497",
									DownloadURL:     "https://catalog.update.microsoft.com/v7/site/Search.aspx?q=KB4012497",
								},
							},
						},
					},
					URL: "https://msrc.microsoft.com/update-guide/vulnerability/CVE-2017-0024",
					Revisions: []model.Revision{
						{
							Number:      "1.0",
							Date:        "2017-03-14T00:00:00Z",
							Description: "\u003cp\u003eInformation published.\u003c/p\u003e\n",
						},
					},
				},
				{
					CVEID: "CVE-2017-0026",
					Title: "Security Update for Windows Kernel-Mode Drivers",
					Products: []model.Product{
						{
							Name:     "Windows 10 Version 1511 for 32-bit Systems",
							Impact:   "Elevation of Privilege",
							Severity: "Important",
							KBs: []model.KB{
								{
									Article:         "4013198",
									RestartRequired: "Yes",
									ArticleURL:      "https://support.microsoft.com/help/4013198",
									DownloadURL:     "https://catalog.update.microsoft.com/v7/site/Search.aspx?q=KB4013198",
								},
							},
						},
						{
							Name:     "Windows Server 2008 for 32-bit Systems Service Pack 2",
							Impact:   "Elevation of Privilege",
							Severity: "Important",
							KBs: []model.KB{
								{
									Article:         "4012497",
									RestartRequired: "Yes",
									ArticleURL:      "https://support.microsoft.com/help/4012497",
									DownloadURL:     "https://catalog.update.microsoft.com/v7/site/Search.aspx?q=KB4012497",
								},
							},
						},
						{
							Name:     "Windows Server 2008 for x64-based Systems Service Pack 2",
							Impact:   "Elevation of Privilege",
							Severity: "Important",
							KBs: []model.KB{
								{
									Article:         "4012497",
									RestartRequired: "Yes",
									ArticleURL:      "https://support.microsoft.com/help/4012497",
									DownloadURL:     "https://catalog.update.microsoft.com/v7/site/Search.aspx?q=KB4012497",
								},
							},
						},
					},
					URL: "https://msrc.microsoft.com/update-guide/vulnerability/CVE-2017-0026",
					Revisions: []model.Revision{
						{
							Number:      "1.0",
							Date:        "2017-03-14T00:00:00Z",
							Description: "\u003cp\u003eInformation published.\u003c/p\u003e\n",
						},
					},
				},
			},
		},
	}

	for i, tt := range tests {
		f, err := os.Open(tt.input)
		if err != nil {
			t.Fatalf("[%d] failed to open %s. err: %s", i, tt.input, err)
		}
		defer f.Close()

		bs, err := io.ReadAll(f)
		if err != nil {
			t.Fatalf("[%d] failed to read %s. err: %s", i, tt.input, err)
		}

		xf, err := xlsx.OpenBinary(bs)
		if err != nil {
			t.Fatalf("[%d] failed to open xlsx. err: %s", i, err)
		}

		bulletins := []Bulletin{}
		for _, sheet := range xf.Sheets {
			for i, row := range sheet.Rows {
				// skip header
				if i == 0 {
					continue
				}

				var line Bulletin
				if err := row.ReadStruct(&line); err != nil {
					t.Fatalf("[%d] failed to read xlsx line. err: %s", i, err)
				}
				bulletins = append(bulletins, line)
			}
		}

		opts := []cmp.Option{
			cmpopts.SortSlices(func(i, j model.Vulnerability) bool {
				return i.CVEID < j.CVEID
			}),
			cmpopts.SortSlices(func(i, j model.Product) bool {
				return i.Name < j.Name
			}),
		}
		if diff := cmp.Diff(tt.expected, Parse(bulletins), opts...); diff != "" {
			t.Errorf("[%d] failed to Parse(). (-expected +got):\n%s", i, diff)
		}
	}
}
